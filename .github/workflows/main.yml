name: CI

on: [push, pull_request]

jobs:
  build:
    name: Build & Test (${{matrix.config.v}})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        config:
          - {v: 'v1.0.6'}
          - {v: 'v1.1.6'}
          - {v: 'v1.3.4'}
# the master runner does not terminate currently
# disable for now until we have time to investigate
#          - {v: 'master'}
    container:
      image: ubuntu:latest
    steps:
    - uses: actions/checkout@v3
    - name: apt update
      run: apt-get update
    - name: Install base packages
      run: |
        apt-get install --yes \
        gpg \
        make \
        software-properties-common \
        git build-essential gcc pkg-config cmake \
        libmbedtls-dev
    - name: Install open62541
      run: |
        cd /tmp
        git clone https://github.com/open62541/open62541
        cd open62541
        git checkout -B ${{matrix.config.v}} ${{matrix.config.v}}
        git submodule update --init --recursive
        mkdir build
        cd build
        cmake -DBUILD_SHARED_LIBS=ON -DCMAKE_BUILD_TYPE=RelWithDebInfo -DUA_NAMESPACE_ZERO=FULL ..
        make
        make install
        ldconfig /usr/local/lib
    - name: Install Perl modules for testing and libopen62541
      run: |
        apt-get install --yes \
        libdevel-checklib-perl \
        libtest-deep-perl \
        libtest-eol-perl \
        libtest-exception-perl \
        libtest-leaktrace-perl \
        libtest-nowarnings-perl \
        libtest-perl-critic-perl \
        libtest-pod-perl \
        libtest-requires-perl \
        libtest-strict-perl \
        libtest-tcp-perl \
        libtest-warn-perl \
        libyaml-tiny-perl
    - name: perl Makefile
      run: perl Makefile.PL
    - name: Make
      run: make
    - name: Test
      run: make test
